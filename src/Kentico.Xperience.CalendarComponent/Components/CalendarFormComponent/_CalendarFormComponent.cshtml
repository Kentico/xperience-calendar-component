@using Kentico.Xperience.CalendarComponent.Components.FormComponents
@using Kentico.Xperience.CalendarComponent.Components
@using Kentico.Forms.Web.Mvc
@using Kentico.Web.Mvc

@model CalendarFormComponent

@{
    var htmlAttributes = ViewData.Kentico().GetEditorHtmlAttributes();
    var calendarId = Html.IdFor(m => m.SelectedDate);
    htmlAttributes["id"] = calendarId;

    string selectedAltFormat = Model.Properties.DateTimeFormat;

    var flatpickrOptions = new
    {
        dateFormat = "m/d/Y h:i:S K",
        altInput = true,
        altFormat = selectedAltFormat,
        defaultDate = new List<string>
                {
                    Model.SelectedDate
                },
        enableTime = !Model.Properties.DateOnly,
        minuteIncrement = Model.Properties.TimeInterval
    };
}

@Html.TextBoxFor(m => m.SelectedDate, htmlAttributes)

<script>
    async function fetchExcludedDateTimeData(dataProviderName) {
        try {
            let response = await fetch(`/kentico.calendarComponent/GetExcludedDateTimeData?dataProviderName=${encodeURIComponent(dataProviderName)}`);
            if (response.ok) {
                let data = await response.json();
                return data;
            } else {
                throw new Error('Failed to fetch data');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            return [];
        }
    }

    async function initializeFlatpickr() {
        let excludedDateTimeData = await fetchExcludedDateTimeData('@Model.Properties.ExcludedDateTimeDataProvider');

        let flatpickrOptions = @Html.Raw(Json.Serialize(flatpickrOptions));
        flatpickrOptions.disable = excludedDateTimeData;

        window.xperience.calendarComponent.initializeFlatpickr("#@calendarId", @Html.Raw(Json.Serialize(flatpickrOptions)));
    }

    var script = document.createElement('script');
    script.src = "~/_content/Kentico.Xperience.CalendarComponent/js/ktc-calendarComponent.js";
    script.onload = initializeFlatpickr;
    document.head.appendChild(script);
</script>